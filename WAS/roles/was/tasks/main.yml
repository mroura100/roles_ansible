---
- name: Install setfacl and unzip on RedHat
  become: true
  yum:
    name: ['acl', 'unzip', 'psmisc']
    state: present
    

- name: Create the {{ibm_user}} user
  become: true
  become_user: root
  user:
    name: "{{ibm_user}}"

- name: Create the {{ibm_root}} directory
  become: true
  become_user: root
  file:
    path: "{{ibm_root}}"
    state: directory
    owner: "{{ibm_user}}"
    group: "{{ibm_user}}"
    mode: 0755

- name: Create the {{iim_path}} directory
  become: true
  become_user: root
  file:
    path: "{{iim_path}}"
    state: directory
    owner: "{{ibm_user}}"
    group: "{{ibm_user}}"
    mode: 0755

- name: Create the {{ was_repo }} directory
  become: true
  become_user: root
  file:
    path: "{{ was_repo }}"
    state: directory
    owner: "{{ibm_user}}"
    group: "{{ibm_user}}"
    mode: 0755

- name: Create the {{ jdk_repo }} directory
  become: true
  become_user: root
  file:
    path: "{{ jdk_repo }}"
    state: directory
    owner: "{{ibm_user}}"
    group: "{{ibm_user}}"
    mode: 0755

- name: Descarregem el instalation manager IIM.
  get_url:
    url: "http://192.168.1.110/was90/gtk.x86_64_1.8.9004.20190423_2015.zip"
    dest: "{{ ibm_repo }}/gtk.x86_64_1.8.9004.20190423_2015.zip"

- name: Descarreguem la versiÃ³ ND del WAS9.
  get_url:
    url: "http://192.168.1.110/was90/was.repo.90501.nd.zip"
    dest: "{{ ibm_repo }}/was.repo.90501.nd.zip"

- name: Descarregem el JAVA.
  get_url:
    url: "http://192.168.1.110/was90/sdk.repo.8035.java8.linux.zip"
    dest: "{{ ibm_repo }}/sdk.repo.8035.java8.linux.zip"

- name: Descomprimim el instalation manager IIM
  become: true
  unarchive:
    src: "{{ ibm_repo }}/gtk.x86_64_1.8.9004.20190423_2015.zip"
    dest: "{{ iim_path }}"
    remote_src: yes
    group: "{{ibm_user}}"
    owner: "{{ibm_user}}"

- name: Descomprimim el was repo
  become: true
  unarchive:
    src: "{{ ibm_repo }}/was.repo.90501.nd.zip"
    dest: "{{ was_repo }}"
    remote_src: yes
    group: "{{ibm_user}}"
    owner: "{{ibm_user}}"

- name: Descomprimim el jdk repo
  become: true
  unarchive:
    src: "{{ ibm_repo }}/sdk.repo.8035.java8.linux.zip"
    dest: "{{ jdk_repo }}"
    remote_src: yes
    group: "{{ibm_user}}"
    owner: "{{ibm_user}}"


- name: Run IIM at {{ iim_path }} to install WAS with JDK at {{ was_path }}
  become: true
  become_user: "{{ was_user }}"
  command: >
    "{{ iim_path }}/tools/imcl"
    "install" "{{ was_imcl_package_name }}"
    "{{ jdk_imcl_package_name }}"
    "-repositories"
    "{{ was_repo }},{{ jdk_repo }}"
    "-installationDirectory"
    "{{ was_path }}"
    "-sharedResourcesDirectory"
    "{{ ibm_shared_path }}"
    "-accessRights"
    "nonAdmin"
    "-acceptLicense"

- name: Create profile DMGR
  become: true
  become_user: "{{ was_user }}"
  command: >
    {{ was_path }}/bin/manageprofiles.sh
    -create
    -profileName dmgr0
    -profilePath '{{ was_profiles_path }}/dmgr'
    -templatePath '{{ was_path }}/profileTemplates/management'
    -serverType DEPLOYMENT_MANAGER
    -nodeName dmgr0
    -cellName cellgc0
    -hostname {{ ansible_hostname }} 

- name: Starting DMGR
  become: true
  become_user: "{{ was_user }}"
  command: "{{ was_profiles_path }}/dmgr/bin/startManager.sh"

- name: Create profile NODE
  become: true
  become_user: "{{ was_user }}"
  command: >
    {{ was_path }}/bin/manageprofiles.sh
    -create
    -profile_name {{ ansible_hostname }}
    -profilePath '{{ was_profiles_path }}/{{ ansible_hostname }}'
    -templatePath '{{ was_path }}/profileTemplates/default'
    -nodeName {{ ansible_hostname }}
    -cellName cellgc1
    -hostname {{ ansible_hostname }}

- name: Federar Nodo
  become: true
  become_user: "{{ was_user }}"
  shell: "{{ was_profiles_path }}/{{ ansible_hostname }}/bin/addNode.sh {{ ansible_hostname }}"



